{"version":3,"sources":["..\\..\\..\\..\\assets\\Script/assets\\Script\\MainMenuManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\assets\\Script","sourcesContent":["\"use strict\";\r\n\r\nimport ItemRoomScrollView from \"../Prefabs/ItemRoomScrollView\";\r\nimport { ConnectionManager } from \"./ConnectionManager\";\r\nimport SnapGame from \"./SnapGame\";\r\nimport WaitingRoomManager from \"./WaitingRoomManager\";\r\nimport JsoSecurityManager from \"./oauth/SecurityManager\";\r\nimport { PlayerClient, IPlayer } from \"./api\";\r\nimport { GameConfiguration } from \"./oauth/GameConfiguration\";\r\nimport { IGameConfiguration, ISecurityManager } from \"./oauth/IGameConfiguration\";\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class MainMenuManager extends cc.Component {\r\n    @property(cc.Label)\r\n    loginNameLbl: cc.Label = null;\r\n\r\n    @property(cc.Label)\r\n    connectionStatusLbl: cc.Label = null;\r\n\r\n    @property(cc.Button)\r\n    loginBtn: cc.Button = null;\r\n\r\n    @property(cc.Button)\r\n    logoutBtn: cc.Button = null;\r\n\r\n    @property(cc.Button)\r\n    reconnectBtn: cc.Button = null;\r\n\r\n    @property(cc.Prefab)\r\n    itemPrefab: cc.Prefab = null;\r\n\r\n    @property(cc.ScrollView)\r\n    roomScrollView: cc.ScrollView = null;\r\n\r\n    @property()\r\n    roomSceneName: string = \"\";\r\n\r\n    private connection: ConnectionManager;\r\n    private oauth: ISecurityManager;\r\n    private playerClient: PlayerClient;\r\n    private readonly gameConfig: IGameConfiguration = new GameConfiguration();\r\n    /**\r\n     *\r\n     */\r\n    onLoad(): void {\r\n        cc.systemEvent\r\n            .on(ConnectionManager.ON_CONNECTED, this.onConnected, this);\r\n        cc.systemEvent\r\n            .on(ConnectionManager.ON_CONNECTION_CLOSED, this.onDisconnected, this);\r\n        cc.systemEvent\r\n            .on(GameConfiguration.ON_PLAYER_DATA_UPDATED, this.onPlayerDataUpdated, this);\r\n        cc.systemEvent\r\n            .on(ConnectionManager.ON_CREATE_ROOM, this.onRoomCreated, this);\r\n        cc.systemEvent\r\n            .on(ConnectionManager.ON_JOIN_GAME_MESSAGE, this.onJoinGame, this);\r\n\r\n        this.gameConfig.oauthConfiguration = {\r\n            providerID: \"snapGameOauth\",\r\n            client_id: \"snapGameApiDevSwagger\",\r\n            authorization: \"https://localhost:52365/connect/authorize\",\r\n            token: \"https://localhost:52365/connect/token\",\r\n            redirect_uri: \"http://localhost:7456\",\r\n            scopes: {\r\n                request: [\"snapgame\"],\r\n            },\r\n            response_type: \"token\",\r\n            nonce: \"636864884858396406.MWI4ZjNkYWItOGU1My00YmFiLTg1MTAtMWQzOTY2OTM4YzRkOGFhOGI1OGItODc0YS00NGEyLWI3NzgtYzU0YmJiMzk5NWY0\"\r\n        };\r\n\r\n        this.gameConfig.apiUrl = \"https://localhost:44378\";\r\n        this.gameConfig.gameServerUrl = \"https://localhost:44378/game_notifications\";\r\n        const fetcher: GlobalFetch = {\r\n            fetch: (input: RequestInfo, init?: RequestInit): Promise<Response> => {\r\n                return this.oauth ? this.oauth.fetch(input, init) : window.fetch(input, init);\r\n            }\r\n        };\r\n        this.playerClient = new PlayerClient(this.gameConfig, this.gameConfig, fetcher);\r\n        this.oauth = new JsoSecurityManager(this.playerClient, this.gameConfig);\r\n        this.connection = new ConnectionManager(this.gameConfig, this.gameConfig);\r\n    }\r\n\r\n    onDestroy(): void {\r\n        cc.systemEvent\r\n            .off(ConnectionManager.ON_CONNECTED, this.onConnected, this);\r\n        cc.systemEvent\r\n            .off(ConnectionManager.ON_CONNECTION_CLOSED, this.onDisconnected, this);\r\n        cc.systemEvent\r\n            .off(GameConfiguration.ON_PLAYER_DATA_UPDATED, this.onPlayerDataUpdated, this);\r\n        cc.systemEvent\r\n            .off(ConnectionManager.ON_CREATE_ROOM, this.onRoomCreated, this);\r\n        cc.systemEvent\r\n            .off(ConnectionManager.ON_JOIN_GAME_MESSAGE, this.onJoinGame, this);\r\n    }\r\n\r\n    start = async (): Promise<void> => {\r\n        await this.refresh();\r\n    }\r\n\r\n    onJoinGame(e: cc.Event.EventCustom): void {\r\n        const joinedUser: string = e.getUserData().username;\r\n        const roomId: any = e.getUserData().roomId;\r\n        if (joinedUser === this.gameConfig.currentPlayer.username) {\r\n            cc.director.loadScene(this.roomSceneName, () => {\r\n                const scene: cc.Scene = cc.director.getScene();\r\n                const game: SnapGame = scene.getChildByName(\"Game\").getComponent(SnapGame);\r\n                const sceneManager: WaitingRoomManager = scene.getChildByName(\"WaitingRoomManager\").getComponent(WaitingRoomManager);\r\n                game.roomId = roomId;\r\n                sceneManager.loadData();\r\n            });\r\n        }\r\n    }\r\n\r\n    createRoom = async (): Promise<void> => {\r\n        await this.connection.createRoom();\r\n    }\r\n\r\n    onRoomCreated(e: cc.Event.EventCustom): void {\r\n        const roomId: any = e.getUserData().roomId;\r\n        const createdBy: any = e.getUserData().createdBy;\r\n        if (createdBy === this.gameConfig.currentPlayer.username) {\r\n            cc.director.loadScene(this.roomSceneName, () => {\r\n                const scene: cc.Scene = cc.director.getScene();\r\n                const game: SnapGame = scene.getChildByName(\"Game\").getComponent(SnapGame);\r\n                const sceneManager: WaitingRoomManager = scene.getChildByName(\"WaitingRoomManager\").getComponent(WaitingRoomManager);\r\n                game.roomId = roomId;\r\n                game.createdBy = createdBy;\r\n                sceneManager.loadData();\r\n            });\r\n            return;\r\n        }\r\n        this.addRoomItem(roomId);\r\n    }\r\n\r\n    private addRoomItem(roomId: number): void {\r\n        cc.log(\"Game created received: \" + roomId);\r\n        const node: cc.Node = cc.instantiate(this.itemPrefab);\r\n        const item: ItemRoomScrollView = node.getComponent(ItemRoomScrollView);\r\n        item.id = roomId;\r\n        const lbl: cc.Label = node.getComponentInChildren(cc.Label);\r\n        lbl.string = `Room #${roomId}`;\r\n        const itemCount: number = this.roomScrollView.content.childrenCount;\r\n        const h: number = node.height + 5;\r\n        const y: number = (itemCount * h);\r\n        this.roomScrollView.content.addChild(node);\r\n        node.setPosition(0, -y);\r\n        this.roomScrollView.content.height += h;\r\n    }\r\n\r\n    onConnected(e: cc.Event.EventCustom): void {\r\n        this.connectionStatusLbl.string = \"Connected\";\r\n    }\r\n\r\n    onDisconnected(e: cc.Event.EventCustom): void {\r\n        this.connectionStatusLbl.string = \"Disconnected\";\r\n    }\r\n\r\n    onPlayerDataUpdated(e: cc.Event.EventCustom): void {\r\n        const player: IPlayer = e.getUserData();\r\n        this.loginNameLbl.string = player && player.username ? player.username : \"Not singed in\";\r\n    }\r\n\r\n    connect = async (): Promise<void> => {\r\n        await this.connection.connect();\r\n    }\r\n\r\n    refresh = async (): Promise<void> => {\r\n        await this.oauth.login();\r\n        await this.connection.connect();\r\n        // const gameRoomApi: api.GameRoomClient = new api.GameRoomClient(\"https://localhost:44378\");\r\n        // const rooms: api.GameRoom[] = await gameRoomApi.getAll();\r\n        // rooms.forEach(room => this.addRoomItem(room.id));\r\n    }\r\n\r\n    login = async (): Promise<void> => {\r\n        await this.oauth.login();\r\n    }\r\n\r\n    logout(): void {\r\n        this.oauth.logout();\r\n    }\r\n}\r\n"]}